name: Helm Deploy (values file) - reusable

on:
  workflow_call:
    inputs:
      release-name:
        type: string
        required: true

      chart-name:
        type: string
        required: true

      chart-repo:
        type: string
        required: true

      namespace:
        type: string
        required: true

      values-file:
        type: string
        required: false
        default: values.yaml

      global-environment:
        type: string
        required: false
        default: ""

      ingress-host:
        type: string
        required: false
        default: ""

      ingress-tls-secret:
        type: string
        required: false
        default: ""

      ingress-path:
        type: string
        required: false
        default: ""

      image-tag:
        type: string
        required: false
        default: ""

      # Keep DB as a normal input (not a secret)
      db-connection:
        type: string
        required: false
        default: ""

      # One key=value per line each becomes --set <line>
      extra-set-values:
        type: string
        required: false
        default: ""

      helm-version:
        type: string
        required: false
        default: v3.14.4

      kubectl-version:
        type: string
        required: false
        default: v1.29.0

      helm-timeout:
        type: string
        required: false
        default: 10m

      atomic:
        type: boolean
        required: false
        default: true

      wait:
        type: boolean
        required: false
        default: true

      create-namespace:
        type: boolean
        required: false
        default: true

      verify-cluster:
        type: boolean
        required: false
        default: true

    secrets:
      kubeconfig64:
        required: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: ${{ inputs.kubectl-version }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Configure kubeconfig (from secret)
        env:
          KUBECONFIG_B64: ${{ secrets.kubeconfig64 }}
        run: |
          set -euo pipefail
          mkdir -p "${HOME}/.kube"
          echo "${KUBECONFIG_B64}" | base64 -d > "${HOME}/.kube/config"
          chmod 600 "${HOME}/.kube/config"

      - name: Verify cluster access
        if: ${{ inputs.verify-cluster }}
        run: |
          set -euo pipefail
          kubectl version --client=true
          kubectl cluster-info
          kubectl get ns "${{ inputs.namespace }}" || true

      - name: Deploy with Helm (upgrade/install)
        env:
          IMAGE_TAG_INPUT: ${{ inputs.image-tag }}
          DB_CONNECTION: ${{ inputs.db-connection }}
          EXTRA_SET_VALUES: ${{ inputs.extra-set-values }}
          HELM_TIMEOUT: ${{ inputs.helm-timeout }}
          ATOMIC: ${{ inputs.atomic }}
          WAIT: ${{ inputs.wait }}
          CREATE_NAMESPACE: ${{ inputs.create-namespace }}
        run: |
          set -euo pipefail

          # Build helm command safely using an array (prevents word splitting and ; command breaks)
          ARGS=(
            upgrade --install
            "${{ inputs.release-name }}"
            "${{ inputs.chart-name }}"
            --repo "${{ inputs.chart-repo }}"
            --namespace "${{ inputs.namespace }}"
            --values "${{ inputs.values-file }}"
            --timeout "${HELM_TIMEOUT}"
          )

          if [ "${CREATE_NAMESPACE}" = "true" ]; then
            ARGS+=(--create-namespace)
          fi
          if [ "${ATOMIC}" = "true" ]; then
            ARGS+=(--atomic)
          fi
          if [ "${WAIT}" = "true" ]; then
            ARGS+=(--wait)
          fi

          if [ -n "${{ inputs.global-environment }}" ]; then
            ARGS+=(--set "global.environment=${{ inputs.global-environment }}")
          fi

          if [ -n "${{ inputs.ingress-host }}" ]; then
            ARGS+=(--set "ingress.hosts={${{ inputs.ingress-host }}}")
          fi

          if [ -n "${{ inputs.ingress-tls-secret }}" ]; then
            ARGS+=(--set "ingress.tls[0].secretName=${{ inputs.ingress-tls-secret }}")
          fi

          if [ -n "${{ inputs.ingress-path }}" ]; then
            ARGS+=(--set "ingress.path=${{ inputs.ingress-path }}")
          fi

          # Quote as one argument so spaces or semicolons don't break the command
          if [ -n "${DB_CONNECTION}" ]; then
            ARGS+=(--set-string "db=${DB_CONNECTION}")
          fi

          if [ -n "${IMAGE_TAG_INPUT}" ]; then
            ARGS+=(--set "image.tag=${IMAGE_TAG_INPUT}")
          fi

          # extra-set-values: one key=value per line
          if [ -n "${EXTRA_SET_VALUES// /}" ]; then
            while IFS= read -r line; do
              line="$(printf '%s' "$line" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//')"
              [ -z "$line" ] && continue
              ARGS+=(--set "$line")
            done <<< "${EXTRA_SET_VALUES}"
          fi

          helm "${ARGS[@]}"

      - name: Show release status
        if: always()
        run: |
          set -euo pipefail
          helm status "${{ inputs.release-name }}" --namespace "${{ inputs.namespace }}" || true
          kubectl get pods --namespace "${{ inputs.namespace }}" -l app.kubernetes.io/instance="${{ inputs.release-name }}" || true
          kubectl get ingress --namespace "${{ inputs.namespace }}" || true
