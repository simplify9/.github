name: Helm Deploy with values file - reusable

on:
  workflow_call:
    inputs:
      release-name:
        type: string
        required: true

      chart-name:
        type: string
        required: true

      chart-repo:
        type: string
        required: true

      namespace:
        type: string
        required: true

      values-file:
        type: string
        required: false
        default: values.yaml

      global-environment:
        type: string
        required: false
        default: ""

      ingress-host:
        type: string
        required: false
        default: ""

      ingress-tls-secret:
        type: string
        required: false
        default: ""

      ingress-path:
        type: string
        required: false
        default: ""

      image-tag:
        type: string
        required: false
        default: ""

      # DB connection is an INPUT (not a secret)
      db-connection:
        type: string
        required: false
        default: ""

      helm-version:
        type: string
        required: false
        default: v3.14.4

      kubectl-version:
        type: string
        required: false
        default: v1.29.0

      helm-timeout:
        type: string
        required: false
        default: 10m

      atomic:
        type: boolean
        required: false
        default: true

      wait:
        type: boolean
        required: false
        default: true

      create-namespace:
        type: boolean
        required: false
        default: true

      verify-cluster:
        type: boolean
        required: false
        default: true

      # One key=value per line, each becomes: --set <line>
      extra-set-values:
        type: string
        required: false
        default: ""

    secrets:
      kubeconfig64:
        required: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: ${{ inputs.kubectl-version }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Configure kubeconfig (from secret)
        env:
          KUBECONFIG_B64: ${{ secrets.kubeconfig64 }}
        run: |
          set -euo pipefail
          mkdir -p "${HOME}/.kube"
          echo "${KUBECONFIG_B64}" | base64 -d > "${HOME}/.kube/config"
          chmod 600 "${HOME}/.kube/config"

      - name: Verify cluster access
        if: ${{ inputs.verify-cluster }}
        run: |
          set -euo pipefail
          kubectl version --client=true
          kubectl cluster-info
          kubectl get ns "${{ inputs.namespace }}" || true

      - name: Deploy with Helm (upgrade/install)
        env:
          IMAGE_TAG_INPUT: ${{ inputs.image-tag }}
          DB_CONNECTION: ${{ inputs.db-connection }}
          EXTRA_SET_VALUES: ${{ inputs.extra-set-values }}
        run: |
          set -euo pipefail

          EXTRA_IMAGE_SET_ARGS=""
          if [ -n "${IMAGE_TAG_INPUT}" ]; then
            EXTRA_IMAGE_SET_ARGS="--set image.tag=${IMAGE_TAG_INPUT}"
          fi

          EXTRA_SET_ARGS=""
          if [ -n "${EXTRA_SET_VALUES// /}" ]; then
            while IFS= read -r line; do
              line="$(printf '%s' "$line" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//')"
              [ -z "$line" ] && continue
              EXTRA_SET_ARGS="${EXTRA_SET_ARGS} --set ${line}"
            done <<< "${EXTRA_SET_VALUES}"
          fi

          helm upgrade --install "${{ inputs.release-name }}" "${{ inputs.chart-name }}" \
            --repo "${{ inputs.chart-repo }}" \
            --namespace "${{ inputs.namespace }}" \
            ${{ inputs.create-namespace && '--create-namespace' || '' }} \
            --values "${{ inputs.values-file }}" \
            ${{ inputs.global-environment != '' && format('--set global.environment={0}', inputs.global-environment) || '' }} \
            ${{ inputs.ingress-host != '' && format('--set ingress.hosts={{{0}}}', inputs.ingress-host) || '' }} \
            ${{ inputs.ingress-tls-secret != '' && format('--set ingress.tls[0].secretName={0}', inputs.ingress-tls-secret) || '' }} \
            ${{ inputs.ingress-path != '' && format('--set ingress.path={0}', inputs.ingress-path) || '' }} \
            $( [ -n "${DB_CONNECTION}" ] && printf '%s' "--set-string db=${DB_CONNECTION}" ) \
            ${EXTRA_IMAGE_SET_ARGS} \
            ${EXTRA_SET_ARGS} \
            ${{ inputs.atomic && '--atomic' || '' }} \
            ${{ inputs.wait && '--wait' || '' }} \
            --timeout "${{ inputs.helm-timeout }}"

      - name: Show release status
        if: always()
        run: |
          set -euo pipefail
          helm status "${{ inputs.release-name }}" --namespace "${{ inputs.namespace }}" || true
          kubectl get pods --namespace "${{ inputs.namespace }}" -l app.kubernetes.io/instance="${{ inputs.release-name }}" || true
          kubectl get ingress --namespace "${{ inputs.namespace }}" || true
