# Next.js Cloudflare Workers CI/CD Template

This reusable workflow template deploys Next.js applications to Cloudflare Workers with **full Next.js 15 support** and smart auto-detection for modern `@cloudflare/next-on-pages` builds. Based on your proven working workflow, it's modular, configurable, and handles everything from dependency installation to custom domain setup.

## ✨ New Features (v2)

- 🆕 **Next.js 15 Compatible**: Auto-detects modern `@cloudflare/next-on-pages` output structure
- 🔍 **Smart Worker Detection**: Automatically handles `_worker.js/index.js` directory structure  
- 🧠 **Smart Asset Handling**: Respects `@cloudflare/next-on-pages` generated files
- ⚡ **Zero Configuration**: Works out-of-the-box with modern Next.js setups

## 🆕 Next.js 15 & Modern Build Support

This template fully supports **Next.js 15** and modern `@cloudflare/next-on-pages` builds:

### Automatic Structure Detection
```bash
# Modern @cloudflare/next-on-pages structure (auto-detected)
.vercel/output/static/
├── _worker.js/
│   ├── index.js          ← Actual worker script
│   ├── nop-build-log.json
│   └── __next-on-pages-dist__/
└── .assetsignore         ← Generated by @cloudflare/next-on-pages
```

### Smart Asset Handling
- ✅ **Respects generated files**: Uses `.assetsignore` created by `@cloudflare/next-on-pages`
- ✅ **Custom override**: Only overrides when you provide custom `assets-ignore-content`
- ✅ **Zero conflicts**: No interference with modern build tools

### Tested Compatibility
- **Next.js**: 15.0.0+ (also supports 13.x, 14.x)
- **React**: 19+ (also supports 18.x)
- **@cloudflare/next-on-pages**: 1.13.16+
- **wrangler**: 3.78.12+

## 🚀 Quick Start

### Basic Usage (NPM)
```yaml
name: Deploy to Workers

on:
  push:
    branches: [staging, main]

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/staging'
    uses: simplify9/.github/.github/workflows/nextjs-workers-ci.yml@main
    with:
      environment: 'staging'
      wrangler-environment: 'staging'
    secrets: inherit

  deploy-production:
    if: github.ref == 'refs/heads/main'
    uses: simplify9/.github/.github/workflows/nextjs-workers-ci.yml@main
    with:
      environment: 'production'
      wrangler-environment: 'production'
    secrets: inherit
```

### Enhanced Configuration Example
```yaml
name: Deploy Next.js to Cloudflare Workers

on:
  push:
    branches: [main, staging]
  workflow_dispatch:

jobs:
  deploy:
    uses: simplify9/.github/.github/workflows/nextjs-workers-ci.yml@main
    with:
      environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      
      # Build Configuration
      node-version: '20'
      package-manager: 'yarn'
      install-command: 'yarn install --frozen-lockfile'
      build-command: 'yarn build'
      cloudflare-build-command: 'npx @cloudflare/next-on-pages@1'
      
      # Auto-Detection (Next.js 15 compatible)
      auto-detect-worker-path: true  # 🆕 Automatically detects _worker.js/index.js
      
      # Path Configuration (optional - auto-detection handles this)
      # wrangler-config-path: 'configs/wrangler.toml'
      # workers-output-dir: 'dist/worker'
      # worker-script-path: 'dist/worker/_worker.js'
      
      # Custom Domain Setup
      setup-custom-domain: 'true'
      worker-name: 'my-nextjs-app'
      domain-pattern: 'app.example.com/*'
      zone-name: 'example.com'
      
      # Quality Gates
      run-lint: 'true'
      run-tests: 'true'
      lint-command: 'yarn lint'
      test-command: 'yarn test'
    secrets: inherit
```

### Your Exact Workflow (Yarn)
```yaml
name: Deploy Next.js to Cloudflare Workers

on:
  push:
    branches: [staging, master]
  workflow_dispatch:

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/staging'
    uses: simplify9/.github/.github/workflows/nextjs-workers-ci.yml@main
    with:
      environment: 'staging'
      target-branch: 'staging'
      node-version: '20'
      package-manager: 'yarn'
      package-manager-cache: 'yarn'
      install-command: 'yarn install --frozen-lockfile'
      lint-command: 'yarn lint'
      build-command: 'yarn build'
      wrangler-environment: 'staging'
      setup-custom-domain: true
      worker-name: 'jibli-www-stg'
      domain-pattern: 'www-stg.jibli.com/*'
      zone-name: 'jibli.com'
    secrets: inherit

  deploy-production:
    if: github.ref == 'refs/heads/master'
    uses: simplify9/.github/.github/workflows/nextjs-workers-ci.yml@main
    with:
      environment: 'production'
      target-branch: 'master'
      node-version: '20'
      package-manager: 'yarn'
      package-manager-cache: 'yarn'
      install-command: 'yarn install --frozen-lockfile'
      lint-command: 'yarn lint'
      build-command: 'yarn build'
      wrangler-environment: 'production'
      setup-custom-domain: true
      worker-name: 'jibli-www'
      domain-pattern: 'jibli.com/*'
      zone-name: 'jibli.com'
    secrets: inherit
```

## 📋 Configuration Options

### Required Inputs
| Input | Description | Example |
|-------|-------------|---------|
| `environment` | Deployment environment | `staging`, `production` |

### Build Configuration
| Input | Description | Default | Example |
|-------|-------------|---------|---------|
| `node-version` | Node.js version | `20` | `18`, `20` |
| `package-manager` | Package manager | `npm` | `npm`, `yarn`, `pnpm` |
| `package-manager-cache` | Cache key | `npm` | `npm`, `yarn`, `pnpm` |
| `install-command` | Install command | `npm ci` | `yarn install --frozen-lockfile` |
| `lint-command` | Lint command | `npm run lint` | `yarn lint` |
| `build-command` | Build command | `npm run build` | `yarn build` |
| `cloudflare-build-command` | Cloudflare build command | `npx @cloudflare/next-on-pages` | `npx @cloudflare/next-on-pages@1` |

### Path Configuration
| Input | Description | Default | Example |
|-------|-------------|---------|---------|
| `auto-detect-worker-path` | Auto-detect worker script path for modern builds | `true` | `false` |
| `wrangler-config-path` | Path to wrangler.toml | `wrangler.toml` | `configs/wrangler.toml` |
| `next-build-output` | Next.js build output directory | `.next` | `dist`, `out` |
| `workers-output-dir` | Workers build output directory | `.vercel/output/static` | `dist/worker` |
| `worker-script-path` | Path to worker script file | `.vercel/output/static/_worker.js` | `dist/worker/_worker.js` |
| `assets-ignore-file` | Path to assets ignore file | `.vercel/output/static/.assetsignore` | `dist/worker/.assetsignore` |
| `assets-ignore-content` | Content for assets ignore file | `_worker.js` | `_worker.js\n*.map` |

> 💡 **Smart Detection**: When `auto-detect-worker-path` is `true` (default), the template automatically detects:
> - **Modern structure**: `.vercel/output/static/_worker.js/index.js` (Next.js 15+)
> - **Legacy structure**: `.vercel/output/static/_worker.js` (older versions)
> - **Fallback**: Uses configured `worker-script-path` if detection fails

### Custom Domain Configuration
| Input | Description | Default | Example |
|-------|-------------|---------|---------|
| `setup-custom-domain` | Setup custom domain routes | `false` | `true` |
| `worker-name` | Worker name for domain routes | `''` | `my-app` |
| `domain-pattern` | Domain pattern for routes | `''` | `app.example.com/*` |
| `zone-name` | Cloudflare zone name | `''` | `example.com` |
| `fail-on-domain-error` | Fail if domain setup fails | `false` | `true` |
| `skip-existing-routes` | Skip if route already exists (CI/CD friendly) | `true` | `false` |

> 🔄 **CI/CD Friendly**: When `skip-existing-routes` is `true` (default), the template checks for existing routes before creating new ones. This prevents failures on subsequent deployments when DNS records already exist.

### Optional Features  
| Input | Description | Default | Type |
|-------|-------------|---------|------|
| `run-lint` | Run linting | `true` | boolean |
| `run-tests` | Run tests | `false` | boolean |
| `test-command` | Test command | `npm test` | string |

### Wrangler Configuration
| Input | Description | Default | Example |
|-------|-------------|---------|---------|
| `wrangler-environment` | Environment from wrangler.toml | `''` | `staging`, `production` |
| `fail-on-domain-error` | Fail on domain error | `false` | `true` |

## 🔧 Required Project Setup

### 1. wrangler.toml Configuration
```toml
name = "my-app"
main = ".vercel/output/static/_worker.js"
compatibility_date = "2024-10-20"
compatibility_flags = ["nodejs_compat"]

[env.staging]
name = "my-app-staging"

[env.production] 
name = "my-app-production"
```

### 2. Next.js Configuration
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    unoptimized: true, // Required for Cloudflare Workers
  },
}

module.exports = nextConfig
```

### 3. Package Dependencies
```json
{
  "devDependencies": {
    "@cloudflare/next-on-pages": "^1.0.0",
    "wrangler": "^3.0.0"
  }
}
```

### 4. Required Secrets
- `CLOUDFLARE_API_TOKEN`
- `CLOUDFLARE_ACCOUNT_ID`

## 🏗️ Architecture

The template uses three modular composite actions:

1. **setup-nextjs**: Handles Node.js setup, dependencies, linting, testing
2. **build-nextjs-workers**: Builds Next.js and converts for Workers
3. **deploy-nextjs-workers**: Deploys to Workers and sets up custom domains

## 🌟 Key Features

### ✅ **Modular Design**
- Reusable composite actions
- Configurable for any project
- No vendor lock-in

### ✅ **Your Proven Workflow**
- Based on your working implementation
- Uses existing wrangler.toml configuration
- Supports custom domain routes

### ✅ **Comprehensive Validation**
- Build output verification
- Deployment confirmation
- Error handling with fallbacks

### ✅ **Flexible Package Managers**
- NPM, Yarn, PNPM support
- Custom install commands
- Proper caching configuration

## 🔗 Related Templates

- [Vite CI/CD](./vite-ci.yml) - For Vite apps to Cloudflare Pages
- [API CI/CD](./api-cicd.yml) - For .NET APIs

## 🐛 Troubleshooting

### Common Issues

1. **Build fails**: Check Next.js configuration has `images: { unoptimized: true }`
2. **Deploy fails**: Verify wrangler.toml exists and is valid
3. **Domain setup fails**: Check worker name and zone configuration

### Debug Mode
Enable debug output by setting the `fail-on-domain-error: true` input to see detailed error messages.